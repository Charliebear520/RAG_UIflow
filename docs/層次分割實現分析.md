# 層次分割實現分析

## 目前實現狀況

### ✅ 已實現的功能

#### 1. 規則-based 分割

- **正則表達式模式**：完整支持「章-節-條-項」結構識別
  ```python
  # 章節標記
  r'^第\s*([一二三四五六七八九十百千0-9]+)\s*章[\u3000\s]*(.*)$'
  # 條文標記
  r'^第\s*([一二三四五六七八九十百千0-9]+(?:之[一二三四五六七八九十0-9]+)?)\s*條[\u3000\s]*(.*)$'
  # 項目標記
  r'^[（(]([0-9０-９一二三四五六七八九十]+)[）)]\s*(.*)$'
  ```

#### 2. 多層級分割支持

- **基本層次分割**：基於正則表達式識別結構
- **結構化層次分割**：基於 JSON 結構數據進行精確分割
- **分割粒度選擇**：支持按章、按節、按條文分割

#### 3. 引用關係處理

- **交叉引用提取**：`extract_cross_references()` 函數
- **引用類型識別**：
  - 條文引用：`第X條第Y項`
  - 自引用：`本法`、`本條例`
  - 外部引用：`其他法律`、`相關法規`
- **metadata 存儲**：`cross_references` 字段

#### 4. 評測系統

- **策略感知評測**：不同策略產生不同結果
- **context precision 和 recall@K**：TF-IDF + 余弦相似度
- **推薦配置差異化**：基於實際策略效果

### ❌ 尚未完全實現的功能

#### 1. span-based chunking

**現狀**：目前沒有實現 span 標記和邊界輔助
**需要**：添加 span metadata 來標記 chunk 在原文中的位置

#### 2. 按項分割

**現狀**：支持識別項目標記，但沒有專門的按項分割模式
**需要**：添加 `chunk_by: "item"` 選項

#### 3. 引用關係保留

**現狀**：能提取引用，但沒有在分塊時特別處理引用關係
**需要**：確保引用條文在同一 chunk 或相關 chunk 中

#### 4. 評測指標優化

**現狀**：使用通用 TF-IDF 評測
**需要**：實現 LegalBench-RAG 標準的專用評測指標

## 改進建議

### 1. 添加 span-based chunking

```python
def chunk_with_span(self, text: str, **kwargs) -> List[Dict[str, Any]]:
    chunks = []
    for i, chunk in enumerate(self.chunk(text, **kwargs)):
        start_pos = text.find(chunk)
        end_pos = start_pos + len(chunk)
        chunks.append({
            "content": chunk,
            "span": {"start": start_pos, "end": end_pos},
            "chunk_id": f"chunk_{i}",
            "metadata": {...}
        })
    return chunks
```

### 2. 添加按項分割模式

```python
elif chunk_by == "item":
    # 按項分割
    for section_data in chapter_data.get("sections", []):
        for article_data in section_data.get("articles", []):
            for item_data in article_data.get("items", []):
                item_chunk = self._build_item_chunk(item_data, ...)
                chunks.append(item_chunk)
```

### 3. 引用關係優化

```python
def preserve_cross_references(self, chunks: List[str], cross_refs: List[str]) -> List[str]:
    # 確保被引用的條文與引用它的條文在同一chunk或相鄰chunk
    optimized_chunks = []
    # 實現邏輯...
    return optimized_chunks
```

### 4. LegalBench-RAG 評測指標

```python
def legal_bench_evaluation(self, questions: List[str], chunks: List[str]) -> Dict[str, float]:
    # 實現LegalBench-RAG專用評測指標
    # precision@K, recall@K, F1@K
    # 特別關注條文完整性
    pass
```

## 測試建議

### 1. 條文完整性測試

- 測試按條文分割是否保持單條文完整性
- 測試引用關係是否正確保留

### 2. 評測指標對比

- 固定分割 vs 層次分割的 precision@K
- 固定分割 vs 層次分割的 recall@K
- 目標：層次分割在條文召回率上提升 30%

### 3. span-based chunking 測試

- 測試 span 標記的準確性
- 測試對精確度的影響
- 目標：precision@K 提升 15%

## 總結

目前的層次分割實現已經達到了基本要求：

- ✅ 規則-based 分割
- ✅ 多層級結構識別
- ✅ 引用關係提取
- ✅ 策略感知評測

但還需要進一步優化：

- ❌ span-based chunking
- ❌ 按項分割模式
- ❌ 引用關係保留優化
- ❌ LegalBench-RAG 專用評測指標

建議優先實現 span-based chunking 和按項分割，這將顯著提升法律文檔 RAG 的效果。
