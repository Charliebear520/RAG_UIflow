# 層次分割（Hierarchical Chunking）實作說明

## 概述

層次分割是一種基於文檔結構的智能分塊策略，特別適合處理法律文檔等結構化文本。本實作提供了兩種層次分割方法：

1. **基本層次分割（HierarchicalChunking）**：基於正則表達式識別文檔結構
2. **結構化層次分割（StructuredHierarchicalChunking）**：基於 JSON 結構數據進行精確分割

## 功能特點

### 基本層次分割

- 自動識別章、節、條、項等法律文檔結構標記
- 支持中文數字和阿拉伯數字
- 支持多種項目標記格式：`一、`、`（一）`、`(1)`、`1.`等
- 智能分塊：在條文邊界強制分塊，保持法律邏輯完整性

### 結構化層次分割

- 基於 PDF 轉換的 JSON 結構數據
- 支持三種分割粒度：按章、按節、按條文
- 保留完整的層次結構信息
- 支持重疊機制，保持上下文連貫性

## 使用方式

### 後端 API

#### 1. 基本分塊配置

```json
{
  "chunk_size": 1000,
  "overlap_ratio": 0.1,
  "strategy": "hierarchical"
}
```

#### 2. 結構化分塊配置

```json
{
  "chunk_size": 1000,
  "overlap_ratio": 0.1,
  "strategy": "structured_hierarchical",
  "chunk_by": "article"
}
```

### 前端使用

在前端 ChunkStrategySelector 組件中，新增了「結構化層次分割」選項：

```typescript
// 策略參數
const params = {
  structured_hierarchical: {
    max_chunk_size: 1000,
    overlap_ratio: 0.1,
    chunk_by: "article", // "chapter" | "section" | "article"
  },
};
```

## 分割策略比較

| 策略       | 分割單位     | 適用場景           | 優點               | 缺點                 |
| ---------- | ------------ | ------------------ | ------------------ | -------------------- |
| 按條文分割 | 單條法律條文 | 精確問答、條文引用 | 邏輯完整、易於檢索 | 可能產生大量小分塊   |
| 按節分割   | 章節內容     | 主題相關問答       | 內容完整、適中粒度 | 可能包含多個條文     |
| 按章分割   | 整章內容     | 概覽性查詢         | 內容全面、分塊少   | 分塊較大、檢索精度低 |

## 技術實現

### 結構識別正則表達式

```python
# 章節標記
chapter_patterns = [
    r'^第\s*([一二三四五六七八九十百千0-9]+)\s*章[\u3000\s]*(.*)$',
    r'^第\s*([0-9]+)\s*章[\u3000\s]*(.*)$'
]

# 條文標記
article_patterns = [
    r'^第\s*([一二三四五六七八九十百千0-9]+(?:之[一二三四五六七八九十0-9]+)?)\s*條[\u3000\s]*(.*)$',
    r'^第\s*([0-9]+(?:之[0-9]+)?)\s*條[\u3000\s]*(.*)$'
]

# 項目標記
item_patterns = [
    r'^[（(]([0-9０-９一二三四五六七八九十]+)[）)]\s*(.*)$',  # （一）、(1)
    r'^([一二三四五六七八九十]+)[、．.）)]\s*(.*)$',  # 一、二、
    r'^([0-9０-９]+)[、．.）)]\s*(.*)$',  # 1.2.3.
    r'^([0-9０-９]+)\s+(.*)$',  # 1 2 3
    r'^([一二三四五六七八九十]+)\s+(.*)$'  # 一 二 三
]
```

### 分塊邏輯

1. **結構檢測**：逐行掃描文本，識別結構標記
2. **分塊決策**：
   - 遇到新條文時強制分塊
   - 超過最大大小時分塊
   - 支持重疊機制保持上下文
3. **元數據保留**：記錄章節條項信息，便於後續檢索

## 測試結果

測試使用《著作權法》樣本文檔：

- **基本層次分割**：成功識別並分割 7 個分塊
- **結構化層次分割**：
  - 按條文分割：6 個分塊
  - 按節分割：3 個分塊
  - 按章分割：2 個分塊

所有測試均通過，結構識別準確，分塊邏輯正確。

## 配置建議

### 法律文檔推薦配置

```json
{
  "strategy": "structured_hierarchical",
  "chunk_by": "article",
  "max_chunk_size": 1000,
  "overlap_ratio": 0.1
}
```

### 一般文檔配置

```json
{
  "strategy": "hierarchical",
  "max_chunk_size": 800,
  "overlap_ratio": 0.15
}
```

## 注意事項

1. **結構化分割需要 JSON 數據**：確保 PDF 上傳時正確解析了文檔結構
2. **重疊比例**：建議設置 0.1-0.2，過高會增加存儲成本
3. **分塊大小**：根據文檔類型和應用場景調整，法律文檔建議 800-1200 字符
4. **性能考量**：結構化分割計算量較大，適合對準確性要求高的場景

## 未來改進

1. **支持更多文檔類型**：擴展到其他結構化文檔
2. **智能分塊大小**：根據內容特徵動態調整
3. **語義邊界檢測**：結合 NLP 技術提升分割質量
4. **自適應重疊**：根據內容相關性調整重疊大小
