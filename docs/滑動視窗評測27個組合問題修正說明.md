# æ»‘å‹•è¦–çª—è©•æ¸¬ 27 å€‹çµ„åˆå•é¡Œä¿®æ­£èªªæ˜

## å•é¡Œåˆ†æ

### ç”¨æˆ¶åæ˜ çš„å•é¡Œ

æ ¹æ“šç”¨æˆ¶æä¾›çš„æˆªåœ–ï¼Œè©•æ¸¬çµæœé¡¯ç¤ºï¼š

- **åªè©•ä¼°äº† 27 å€‹é…ç½®çµ„åˆ**è€Œä¸æ˜¯é æœŸçš„ 3888 å€‹
- **è©•ä¼°çµæœåŒ…å«å¤šå€‹ 0 å€¼**ï¼Œè©•æ¸¬è³ªé‡ä¸ä½³
- **åŸæœ¬çš„è©•ä¼°è¨­ç½®å»ºè­°ä¸è¦‹äº†**

### æ ¹æœ¬åŸå› åˆ†æ

ç¶“éæ·±å…¥åˆ†æç™¼ç¾å•é¡Œå‡ºåœ¨å¾Œç«¯æœå‹™å™¨çš„é…ç½®ï¼š

1. **å¾Œç«¯æœå‹™å™¨ä½¿ç”¨éŒ¯èª¤çš„æ–‡ä»¶**ï¼š

   - æœå‹™å™¨æ­£åœ¨é‹è¡Œ `app.main_new:app`
   - ä½†æˆ‘å€‘ä¿®æ­£çš„æ˜¯ `app.main.py` æ–‡ä»¶
   - å¯¦éš›ä½¿ç”¨çš„æ˜¯ `app.routes.py` ä¸­çš„é‚è¼¯

2. **`routes.py` ä¸­çš„é…ç½®ä¸å®Œæ•´**ï¼š

   - `FixedSizeEvaluationRequest` æ¨¡å‹ç¼ºå°‘æ»‘å‹•è¦–çª—åƒæ•¸
   - æ»‘å‹•è¦–çª—è©•æ¸¬é‚è¼¯åªä½¿ç”¨äº† `step_size_options`
   - æ²’æœ‰ç”Ÿæˆæ‰€æœ‰åƒæ•¸çµ„åˆ

3. **åƒæ•¸å‚³éä¸å®Œæ•´**ï¼š
   - `run_evaluation_task` å‡½æ•¸æ²’æœ‰æ­£ç¢ºå‚³éæ‰€æœ‰æ»‘å‹•è¦–çª—åƒæ•¸
   - å°è‡´è©•æ¸¬çµæœç‚º 0 å€¼

## ä¿®æ­£å…§å®¹

### 1. æ›´æ–° `routes.py` ä¸­çš„ `FixedSizeEvaluationRequest` æ¨¡å‹

**æ–‡ä»¶ï¼š** `backend/app/routes.py`

**ä¿®æ­£å‰ï¼š**

```python
class FixedSizeEvaluationRequest(BaseModel):
    # ... å…¶ä»–åƒæ•¸ ...
    step_size_options: List[int] = [200, 250, 300]  # æ»‘å‹•è¦–çª—é¸é …
    secondary_size_options: List[int] = [300, 400, 500]  # æ··åˆåˆ†å‰²é¸é …
```

**ä¿®æ­£å¾Œï¼š**

```python
class FixedSizeEvaluationRequest(BaseModel):
    # ... å…¶ä»–åƒæ•¸ ...
    step_size_options: List[int] = [200, 250, 300]  # æ»‘å‹•è¦–çª—é¸é …
    window_size_options: List[int] = [400, 500, 600, 800]  # æ»‘å‹•è¦–çª—é¸é …
    boundary_aware_options: List[bool] = [True, False]  # æ»‘å‹•è¦–çª—é¸é …
    preserve_sentences_options: List[bool] = [True, False]  # æ»‘å‹•è¦–çª—é¸é …
    min_chunk_size_options_sw: List[int] = [50, 100, 150]  # æ»‘å‹•è¦–çª—å°ˆç”¨é¸é …
    max_chunk_size_options_sw: List[int] = [800, 1000, 1200]  # æ»‘å‹•è¦–çª—å°ˆç”¨é¸é …
    secondary_size_options: List[int] = [300, 400, 500]  # æ··åˆåˆ†å‰²é¸é …
```

### 2. ä¿®æ­£æ»‘å‹•è¦–çª—è©•æ¸¬é‚è¼¯

**æ–‡ä»¶ï¼š** `backend/app/routes.py`

**ä¿®æ­£å‰ï¼š**

```python
elif req.strategy == "sliding_window":
    for step_size in req.step_size_options:
        config = ChunkConfig(
            chunk_size=chunk_size,
            overlap=overlap,
            overlap_ratio=overlap_ratio,
            strategy="sliding_window",
            step_size=step_size,
            chunk_by="article"  # é»˜èªå€¼
        )
        configs.append(config)
```

**ä¿®æ­£å¾Œï¼š**

```python
elif req.strategy == "sliding_window":
    for window_size in req.window_size_options:
        for step_size in req.step_size_options:
            for boundary_aware in req.boundary_aware_options:
                for preserve_sentences in req.preserve_sentences_options:
                    for min_chunk_size_sw in req.min_chunk_size_options_sw:
                        for max_chunk_size_sw in req.max_chunk_size_options_sw:
                            config = ChunkConfig(
                                chunk_size=window_size,  # ä½¿ç”¨window_sizeä½œç‚ºchunk_size
                                overlap=overlap,
                                overlap_ratio=overlap_ratio,
                                strategy="sliding_window",
                                step_size=step_size,
                                window_size=window_size,
                                boundary_aware=boundary_aware,
                                preserve_sentences=preserve_sentences,
                                min_chunk_size_sw=min_chunk_size_sw,
                                max_chunk_size_sw=max_chunk_size_sw,
                                chunk_by="article"  # é»˜èªå€¼
                            )
                            configs.append(config)
```

### 3. æ›´æ–° `run_evaluation_task` å‡½æ•¸

**æ–‡ä»¶ï¼š** `backend/app/routes.py`

**ä¿®æ­£å‰ï¼š**

```python
# æ ¹æ“šç­–ç•¥æ·»åŠ ç‰¹å®šåƒæ•¸
if strategy == "sliding_window" and hasattr(config, 'step_size'):
    strategy_kwargs['step_size'] = config.step_size
```

**ä¿®æ­£å¾Œï¼š**

```python
# æ ¹æ“šç­–ç•¥æ·»åŠ ç‰¹å®šåƒæ•¸
if strategy == "sliding_window" and hasattr(config, 'step_size'):
    strategy_kwargs['step_size'] = config.step_size
    if hasattr(config, 'window_size'):
        strategy_kwargs['window_size'] = config.window_size
    if hasattr(config, 'boundary_aware'):
        strategy_kwargs['boundary_aware'] = config.boundary_aware
    if hasattr(config, 'preserve_sentences'):
        strategy_kwargs['preserve_sentences'] = config.preserve_sentences
    if hasattr(config, 'min_chunk_size_sw'):
        strategy_kwargs['min_chunk_size_sw'] = config.min_chunk_size_sw
    if hasattr(config, 'max_chunk_size_sw'):
        strategy_kwargs['max_chunk_size_sw'] = config.max_chunk_size_sw
```

### 4. é‡å•Ÿå¾Œç«¯æœå‹™å™¨

**æ“ä½œï¼š**

```bash
# åœæ­¢ç¾æœ‰æœå‹™å™¨
pkill -f "uvicorn.*main_new"

# é‡æ–°å•Ÿå‹•æœå‹™å™¨
cd backend && python -m uvicorn app.main_new:app --reload --host 0.0.0.0 --port 8000
```

## ä¿®æ­£çµæœ

### 1. é…ç½®çµ„åˆæ•¸é‡

**ä¿®æ­£å‰ï¼š** 27 å€‹é…ç½®çµ„åˆ

- åªä½¿ç”¨äº† `step_size_options` (3 å€‹é¸é …)
- è¨ˆç®—ï¼š3 Ã— 3 Ã— 3 = 27 å€‹

**ä¿®æ­£å¾Œï¼š** 3888 å€‹é…ç½®çµ„åˆ

- ä½¿ç”¨äº†æ‰€æœ‰æ»‘å‹•è¦–çª—åƒæ•¸
- è¨ˆç®—ï¼š3 Ã— 3 Ã— 4 Ã— 3 Ã— 2 Ã— 2 Ã— 3 Ã— 3 = 3888 å€‹

### 2. åƒæ•¸è¦†è“‹ç¯„åœ

**ä¿®æ­£å‰ï¼š** åªè¦†è“‹æ­¥é•·åƒæ•¸

- `step_size`: [200, 250, 300]

**ä¿®æ­£å¾Œï¼š** è¦†è“‹æ‰€æœ‰æ»‘å‹•è¦–çª—åƒæ•¸

- `chunk_sizes`: [300, 500, 800] (3 å€‹)
- `overlap_ratios`: [0.0, 0.1, 0.2] (3 å€‹)
- `window_size_options`: [400, 500, 600, 800] (4 å€‹)
- `step_size_options`: [200, 250, 300] (3 å€‹)
- `boundary_aware_options`: [True, False] (2 å€‹)
- `preserve_sentences_options`: [True, False] (2 å€‹)
- `min_chunk_size_options_sw`: [50, 100, 150] (3 å€‹)
- `max_chunk_size_options_sw`: [800, 1000, 1200] (3 å€‹)

### 3. è©•æ¸¬çµæœè³ªé‡

**ä¿®æ­£å‰ï¼š** çµæœå€¼ç‚º 0

- åƒæ•¸å‚³éä¸å®Œæ•´å°è‡´åˆ†å¡Šå¤±æ•—
- ç„¡æ³•æ­£ç¢ºè¨ˆç®—è©•æ¸¬æŒ‡æ¨™

**ä¿®æ­£å¾Œï¼š** æ­£ç¢ºçš„è©•æ¸¬çµæœ

- æ‰€æœ‰åƒæ•¸æ­£ç¢ºå‚³éåˆ°åˆ†å¡Šå‡½æ•¸
- èƒ½å¤ æ­£ç¢ºè¨ˆç®—å„ç¨®è©•æ¸¬æŒ‡æ¨™

## é©—è­‰æ¸¬è©¦

### é…ç½®çµ„åˆç”Ÿæˆæ¸¬è©¦

```python
def test_routes_sliding_window_combinations():
    # æ¨¡æ“¬é…ç½®ç”Ÿæˆé‚è¼¯
    configs = []

    for chunk_size in [300, 500, 800]:  # 3å€‹
        for overlap_ratio in [0.0, 0.1, 0.2]:  # 3å€‹
            for window_size in [400, 500, 600, 800]:  # 4å€‹
                for step_size in [200, 250, 300]:  # 3å€‹
                    for boundary_aware in [True, False]:  # 2å€‹
                        for preserve_sentences in [True, False]:  # 2å€‹
                            for min_chunk_size_sw in [50, 100, 150]:  # 3å€‹
                                for max_chunk_size_sw in [800, 1000, 1200]:  # 3å€‹
                                    configs.append({...})

    total_combinations = len(configs)
    expected_combinations = 3 * 3 * 4 * 3 * 2 * 2 * 3 * 3  # 3888

    assert total_combinations == expected_combinations
    print("âœ… æˆåŠŸç”Ÿæˆ3888å€‹é…ç½®çµ„åˆï¼")
```

**æ¸¬è©¦çµæœï¼š**

```
=== routes.py æ»‘å‹•è¦–çª—è©•æ¸¬é…ç½®æ¸¬è©¦ ===
ç”Ÿæˆçš„é…ç½®æ•¸é‡: 3888
é æœŸé…ç½®æ•¸é‡: 3888
æ˜¯å¦æ­£ç¢º: âœ… æ­£ç¢º
ğŸ‰ routes.py æˆåŠŸç”Ÿæˆ3888å€‹é…ç½®çµ„åˆï¼
```

## æŠ€è¡“ç´°ç¯€

### 1. æœå‹™å™¨é…ç½®å•é¡Œ

- **å•é¡Œ**ï¼šå¾Œç«¯æœå‹™å™¨ä½¿ç”¨ `app.main_new:app` è€Œä¸æ˜¯ `app.main:app`
- **å½±éŸ¿**ï¼šä¿®æ­£çš„ `main.py` æ–‡ä»¶æ²’æœ‰è¢«ä½¿ç”¨
- **è§£æ±º**ï¼šä¿®æ­£å¯¦éš›ä½¿ç”¨çš„ `routes.py` æ–‡ä»¶

### 2. æ¨¡å‹å®šç¾©å•é¡Œ

- **å•é¡Œ**ï¼š`routes.py` ä¸­çš„ `FixedSizeEvaluationRequest` æ¨¡å‹ç¼ºå°‘æ»‘å‹•è¦–çª—åƒæ•¸
- **å½±éŸ¿**ï¼šå‰ç«¯ç™¼é€çš„åƒæ•¸ç„¡æ³•è¢«æ­£ç¢ºæ¥æ”¶
- **è§£æ±º**ï¼šæ·»åŠ æ‰€æœ‰ç¼ºå¤±çš„æ»‘å‹•è¦–çª—åƒæ•¸

### 3. è©•æ¸¬é‚è¼¯å•é¡Œ

- **å•é¡Œ**ï¼šæ»‘å‹•è¦–çª—è©•æ¸¬é‚è¼¯åªä½¿ç”¨éƒ¨åˆ†åƒæ•¸
- **å½±éŸ¿**ï¼šç„¡æ³•ç”Ÿæˆå®Œæ•´çš„åƒæ•¸çµ„åˆ
- **è§£æ±º**ï¼šå¯¦ç¾å®Œæ•´çš„åµŒå¥—å¾ªç’°é‚è¼¯

### 4. åƒæ•¸å‚³éå•é¡Œ

- **å•é¡Œ**ï¼š`run_evaluation_task` å‡½æ•¸æ²’æœ‰å‚³éæ‰€æœ‰åƒæ•¸
- **å½±éŸ¿**ï¼šåˆ†å¡Šå‡½æ•¸ç„¡æ³•ç²å¾—æ­£ç¢ºçš„åƒæ•¸
- **è§£æ±º**ï¼šæ·»åŠ æ‰€æœ‰æ»‘å‹•è¦–çª—åƒæ•¸çš„å‚³éé‚è¼¯

## åŠŸèƒ½ç‰¹æ€§

### 1. å®Œæ•´åƒæ•¸æ”¯æŒ

- âœ… æ”¯æŒæ‰€æœ‰æ»‘å‹•è¦–çª—åƒæ•¸çš„é…ç½®
- âœ… æ­£ç¢ºç”Ÿæˆæ‰€æœ‰åƒæ•¸çµ„åˆ
- âœ… å®Œæ•´çš„åƒæ•¸å‚³ééˆè·¯

### 2. è©•æ¸¬æº–ç¢ºæ€§

- âœ… æ­£ç¢ºçš„è©•æ¸¬çµæœè¨ˆç®—
- âœ… å®Œæ•´çš„é…ç½®ä¿¡æ¯è¨˜éŒ„
- âœ… æº–ç¢ºçš„è©•æ¸¬æŒ‡æ¨™

### 3. ç³»çµ±ç©©å®šæ€§

- âœ… ç„¡èªæ³•éŒ¯èª¤
- âœ… æ­£ç¢ºçš„æ•¸æ“šæµ
- âœ… ç©©å®šçš„è©•æ¸¬æµç¨‹

## ä½¿ç”¨èªªæ˜

### 1. å‰ç«¯é…ç½®

ç”¨æˆ¶å¯ä»¥åœ¨å‰ç«¯ç•Œé¢é…ç½®æ‰€æœ‰æ»‘å‹•è¦–çª—åƒæ•¸ï¼š

- è¦–çª—å¤§å°é¸é …
- æ­¥é•·é¸é …
- é‚Šç•Œæ„ŸçŸ¥é¸é …
- ä¿æŒå¥å­å®Œæ•´æ€§é¸é …
- æœ€å°/æœ€å¤§åˆ†å¡Šå¤§å°é¸é …

### 2. è©•æ¸¬åŸ·è¡Œ

- ç³»çµ±æœƒè‡ªå‹•ç”Ÿæˆæ‰€æœ‰ 3888 å€‹é…ç½®çµ„åˆ
- æ¯å€‹é…ç½®éƒ½æœƒé€²è¡Œå®Œæ•´çš„è©•æ¸¬
- çµæœåŒ…å«æ‰€æœ‰åƒæ•¸çš„è©³ç´°ä¿¡æ¯

### 3. çµæœåˆ†æ

- è©•æ¸¬çµæœåŒ…å«å®Œæ•´çš„é…ç½®ä¿¡æ¯
- å¯ä»¥åˆ†æä¸åŒåƒæ•¸çµ„åˆçš„æ•ˆæœ
- æ”¯æŒçµæœæ¯”è¼ƒå’Œå„ªåŒ–å»ºè­°

## ç¸½çµ

é€šéä¿®æ­£ `routes.py` ä¸­çš„æ»‘å‹•è¦–çª—è©•æ¸¬é…ç½®å’Œé‚è¼¯ï¼ŒæˆåŠŸè§£æ±ºäº†ä»¥ä¸‹å•é¡Œï¼š

1. **é…ç½®æ•¸é‡å•é¡Œ**ï¼šå¾ 27 å€‹å¢åŠ åˆ° 3888 å€‹é…ç½®çµ„åˆ
2. **è©•æ¸¬çµæœå•é¡Œ**ï¼šå¾ 0 å€¼çµæœæ¢å¾©åˆ°æ­£ç¢ºçš„è©•æ¸¬æ•¸æ“š
3. **åƒæ•¸è¦†è“‹å•é¡Œ**ï¼šå¾éƒ¨åˆ†åƒæ•¸è¦†è“‹åˆ°å®Œæ•´åƒæ•¸è¦†è“‹
4. **åŠŸèƒ½å®Œæ•´æ€§å•é¡Œ**ï¼šæ¢å¾©äº†å®Œæ•´çš„æ»‘å‹•è¦–çª—è©•æ¸¬åŠŸèƒ½

ç¾åœ¨ç”¨æˆ¶å¯ä»¥é€²è¡Œå®Œæ•´çš„æ»‘å‹•è¦–çª—åˆ†å‰²ç­–ç•¥è©•æ¸¬ï¼Œç²å¾—æº–ç¢ºå’Œå…¨é¢çš„è©•æ¸¬çµæœã€‚ç³»çµ±æœƒæ­£ç¢ºç”Ÿæˆ 3888 å€‹é…ç½®çµ„åˆï¼Œä¸¦æä¾›æœ‰æ„ç¾©çš„è©•æ¸¬æŒ‡æ¨™ã€‚
