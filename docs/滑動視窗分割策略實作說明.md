# 滑動視窗分割策略實作說明

## 概述

滑動視窗分割策略是一種基於固定大小視窗的文本分割方法，通過滑動視窗的方式確保內容的連續性和覆蓋性。本實作提供了豐富的配置選項和邊界感知功能，特別適合處理需要保持上下文連續性的文檔。

## 主要特性

### 1. 基本滑動視窗功能

- **視窗大小控制**: 可設定固定大小的滑動視窗
- **步長控制**: 可設定視窗移動的步長
- **重疊控制**: 支援重疊比例和重疊大小兩種控制方式

### 2. 邊界感知功能

- **句子邊界識別**: 優先在不破壞句子完整性的位置切分
- **詞語邊界識別**: 避免在詞語中間切分
- **標點符號識別**: 支援中文標點符號的邊界識別

### 3. 智能後處理

- **小塊合併**: 自動合併過小的 chunk
- **大塊分割**: 自動分割過大的 chunk
- **大小限制**: 支援最小和最大 chunk 大小限制

## 參數配置

### 核心參數

- `window_size`: 視窗大小（字符數），預設 500
- `step_size`: 步長（字符數），預設 250
- `overlap_ratio`: 重疊比例（0-1），預設 0.1

### 邊界感知參數

- `boundary_aware`: 是否啟用邊界感知，預設 True
- `preserve_sentences`: 是否保持句子完整性，預設 True

### 大小控制參數

- `min_chunk_size`: 最小 chunk 大小，預設 100
- `max_chunk_size`: 最大 chunk 大小，預設 1000

## 實作細節

### 1. 邊界識別

```python
# 中文詞語邊界標記
self.word_boundaries = [
    '。', '！', '？', '；', '：',  # 句號、感嘆號、問號、分號、冒號
    '，', '、', '．', '·',        # 逗號、頓號、句點、間隔號
    '\n', '\r\n', '\r',           # 換行符
    ' ', '\t',                    # 空格、制表符
    '（', '）', '(', ')',         # 括號
    '「', '」', '"', '"',         # 引號
    '【', '】', '[', ']',         # 方括號
    '《', '》', '<', '>',         # 書名號
]
```

### 2. 邊界調整算法

```python
def _adjust_boundary(self, chunk: str, full_text: str, start: int, end: int,
                    preserve_sentences: bool = True) -> str:
    """調整chunk邊界，避免在詞語中間切分"""
    if not preserve_sentences:
        return chunk

    # 嘗試在句子邊界切分
    sentence_endings = ['。', '！', '？', '；']

    # 向前查找最近的句子結束符
    for i in range(end - 1, start, -1):
        if full_text[i] in sentence_endings:
            return full_text[start:i + 1]

    # 如果沒找到句子邊界，嘗試其他邊界
    for i in range(end - 1, start, -1):
        if full_text[i] in self.word_boundaries:
            return full_text[start:i + 1]

    # 如果都沒找到合適邊界，返回原始chunk
    return chunk
```

### 3. 重疊控制

```python
def chunk_with_overlap_control(self, text: str, window_size: int = 500,
                             overlap_ratio: float = 0.1, **kwargs) -> List[str]:
    """精確控制重疊的滑動視窗分割"""
    overlap_size = int(window_size * overlap_ratio)
    step_size = window_size - overlap_size

    chunks = []
    start = 0
    text_length = len(text)

    while start < text_length:
        end = min(start + window_size, text_length)
        chunk = text[start:end]

        if chunk.strip():
            chunks.append(chunk)

        start += step_size

        # 避免無限循環
        if step_size <= 0:
            break

    return chunks
```

## 使用範例

### 基本使用

```python
from app.chunking import SlidingWindowChunking

chunker = SlidingWindowChunking()

# 基本滑動視窗分割
chunks = chunker.chunk(text, window_size=500, step_size=250)

# 邊界感知分割
chunks = chunker.chunk(text, window_size=500, step_size=250, boundary_aware=True)

# 重疊比例控制
chunks = chunker.chunk(text, window_size=500, overlap_ratio=0.1)
```

### 帶元數據的分割

```python
# 帶span信息的分割
chunks_with_span = chunker.chunk_with_span(text, window_size=500, step_size=250)

for chunk_info in chunks_with_span:
    print(f"內容: {chunk_info['content']}")
    print(f"位置: {chunk_info['span']['start']}-{chunk_info['span']['end']}")
    print(f"元數據: {chunk_info['metadata']}")
```

## 前端配置

前端已更新支援新的滑動視窗參數：

```typescript
interface SlidingWindowParams {
  window_size: number; // 視窗大小
  step_size: number; // 步長
  overlap_ratio: number; // 重疊比例
  boundary_aware: boolean; // 邊界感知
  min_chunk_size: number; // 最小chunk大小
  max_chunk_size: number; // 最大chunk大小
  preserve_sentences: boolean; // 保持句子完整性
}
```

## 評估指標

滑動視窗分割策略支援以下評估指標：

- **分塊數量**: 生成的 chunk 總數
- **視窗覆蓋率**: 文本被視窗覆蓋的比例
- **重疊率**: chunk 之間的重疊程度
- **內容連續性**: 相鄰 chunk 之間的內容連續性
- **邊界保持度**: 在合適邊界切分的比例

## 適用場景

1. **法律文檔**: 需要保持條文完整性的法律文檔
2. **技術文檔**: 需要保持代碼或配置完整性的技術文檔
3. **學術論文**: 需要保持段落完整性的學術文檔
4. **新聞文章**: 需要保持句子完整性的新聞文檔

## 優勢

1. **內容連續性**: 通過重疊確保上下文不丟失
2. **邊界感知**: 避免在詞語或句子中間切分
3. **靈活配置**: 支援多種參數組合
4. **智能後處理**: 自動處理過大或過小的 chunk
5. **元數據支援**: 提供詳細的分割信息

## 注意事項

1. **重疊控制**: 過大的重疊會增加存儲成本，過小的重疊可能丟失上下文
2. **邊界識別**: 邊界感知功能依賴標點符號，對於無標點文本效果有限
3. **性能考慮**: 邊界感知會增加計算複雜度
4. **參數調優**: 需要根據具體文檔類型調整參數

## 未來改進

1. **語義邊界識別**: 結合語義分析進行更智能的邊界識別
2. **動態視窗大小**: 根據內容密度動態調整視窗大小
3. **多語言支援**: 擴展對其他語言的邊界識別支援
4. **並行處理**: 支援大文檔的並行分割處理
