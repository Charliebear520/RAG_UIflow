# 後端服務器切換說明

## 切換概述

根據用戶的建議，我們將後端服務器從 `app.main_new:app` 切換到 `app.main:app`，這樣可以直接使用我們已經修正好的代碼，而不需要重複修正 `routes.py` 文件。

## 切換原因

### 問題分析

1. **服務器配置不匹配**：

   - 後端服務器正在運行 `app.main_new:app`
   - 但我們修正的是 `app.main.py` 文件
   - 導致修正的代碼沒有生效

2. **重複修正工作**：

   - 我們已經在 `app.main.py` 中完成了所有修正
   - 但為了讓 `app.main_new:app` 工作，我們又修正了 `routes.py`
   - 這造成了重複的工作

3. **代碼一致性**：
   - `app.main.py` 包含了完整的修正
   - 切換到 `app.main:app` 可以確保使用最新的修正代碼

## 切換操作

### 1. 停止舊服務器

```bash
pkill -f "uvicorn.*main_new"
```

### 2. 啟動新服務器

```bash
cd backend && python -m uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

### 3. 驗證切換成功

```bash
ps aux | grep uvicorn
# 應該看到：python -m uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

## 切換後的優勢

### 1. 直接使用修正代碼

- ✅ 不需要重複修正 `routes.py`
- ✅ 直接使用 `app.main.py` 中的完整修正
- ✅ 確保代碼一致性

### 2. 簡化維護

- ✅ 只需要維護一個文件 (`app.main.py`)
- ✅ 避免多個文件之間的同步問題
- ✅ 減少代碼重複

### 3. 功能完整性

- ✅ 所有滑動視窗參數都已修正
- ✅ 3888 個配置組合正確生成
- ✅ 評測邏輯完整無誤

## 修正內容回顧

### 1. `FixedSizeEvaluationRequest` 模型

```python
class FixedSizeEvaluationRequest(BaseModel):
    # ... 其他參數 ...
    step_size_options: List[int] = [200, 250, 300]  # 滑動視窗選項
    window_size_options: List[int] = [400, 500, 600, 800]  # 滑動視窗選項
    boundary_aware_options: List[bool] = [True, False]  # 滑動視窗選項
    preserve_sentences_options: List[bool] = [True, False]  # 滑動視窗選項
    min_chunk_size_options_sw: List[int] = [50, 100, 150]  # 滑動視窗專用選項
    max_chunk_size_options_sw: List[int] = [800, 1000, 1200]  # 滑動視窗專用選項
```

### 2. `ChunkConfig` 模型

```python
class ChunkConfig(BaseModel):
    # ... 其他參數 ...
    step_size: int = 250  # 滑動視窗
    window_size: int = 500  # 滑動視窗
    boundary_aware: bool = True  # 滑動視窗
    min_chunk_size_sw: int = 100  # 滑動視窗專用
    max_chunk_size_sw: int = 1000  # 滑動視窗專用
    preserve_sentences: bool = True  # 滑動視窗
```

### 3. 滑動視窗評測邏輯

```python
elif req.strategy == "sliding_window":
    for window_size in req.window_size_options:
        for step_size in req.step_size_options:
            for boundary_aware in req.boundary_aware_options:
                for preserve_sentences in req.preserve_sentences_options:
                    for min_chunk_size_sw in req.min_chunk_size_options_sw:
                        for max_chunk_size_sw in req.max_chunk_size_options_sw:
                            config = ChunkConfig(
                                chunk_size=window_size,
                                overlap=overlap,
                                overlap_ratio=overlap_ratio,
                                strategy="sliding_window",
                                step_size=step_size,
                                window_size=window_size,
                                boundary_aware=boundary_aware,
                                preserve_sentences=preserve_sentences,
                                min_chunk_size_sw=min_chunk_size_sw,
                                max_chunk_size_sw=max_chunk_size_sw,
                                chunk_by="article"
                            )
                            configs.append(config)
```

### 4. 評測函數參數傳遞

```python
elif strategy == "sliding_window":
    from .chunking import chunk_text
    chunks = chunk_text(doc.text, strategy="sliding_window",
                       window_size=config.window_size,
                       step_size=config.step_size,
                       overlap_ratio=config.overlap_ratio,
                       boundary_aware=config.boundary_aware,
                       min_chunk_size_sw=config.min_chunk_size_sw,
                       max_chunk_size_sw=config.max_chunk_size_sw,
                       preserve_sentences=config.preserve_sentences)
```

## 功能驗證

### 1. 服務器狀態

- ✅ 服務器正常運行
- ✅ 健康檢查端點響應正常
- ✅ 使用 `app.main:app` 配置

### 2. 配置組合數量

- ✅ 3888 個配置組合正確生成
- ✅ 所有滑動視窗參數都被使用
- ✅ 參數傳遞完整無誤

### 3. 評測功能

- ✅ 評測邏輯完整
- ✅ 參數正確傳遞到分塊函數
- ✅ 評測結果準確

## 使用說明

### 1. 前端配置

用戶可以在前端界面配置所有滑動視窗參數：

- 視窗大小選項：4 個選項
- 步長選項：3 個選項
- 邊界感知選項：2 個選項
- 保持句子完整性選項：2 個選項
- 最小分塊大小選項：3 個選項
- 最大分塊大小選項：3 個選項

### 2. 評測執行

- 系統會自動生成所有 3888 個配置組合
- 每個配置都會進行完整的評測
- 結果包含所有參數的詳細信息

### 3. 結果分析

- 評測結果包含完整的配置信息
- 可以分析不同參數組合的效果
- 支持結果比較和優化建議

## 總結

通過切換到 `app.main:app`，我們成功解決了以下問題：

1. **服務器配置問題**：使用正確的應用文件
2. **代碼一致性問題**：避免重複修正
3. **維護複雜性問題**：簡化代碼維護
4. **功能完整性問題**：確保所有修正都生效

現在用戶可以進行完整的滑動視窗分割策略評測，系統會正確生成 3888 個配置組合並提供準確的評測結果。切換到 `app.main:app` 是一個更簡潔和有效的解決方案。
