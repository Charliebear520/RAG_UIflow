# 層次分割改進完成說明

## 新增功能

### 1. span-based chunking ✅

**實現位置**：`HierarchicalChunking.chunk_with_span()`

**功能特點**：

- 返回包含 span 信息的 chunk 列表
- 每個 chunk 包含在原文中的起始和結束位置
- 包含豐富的 metadata 信息

**使用方式**：

```python
chunker = HierarchicalChunking()
chunks_with_span = chunker.chunk_with_span(text, max_chunk_size=1000)

# 返回格式
[
    {
        "content": "第1條 法律條文內容...",
        "span": {"start": 0, "end": 150},
        "chunk_id": "hierarchical_chunk_0",
        "metadata": {
            "level": "article",
            "number": "一",
            "content_preview": "法律條文內容",
            "length": 150,
            "strategy": "hierarchical"
        }
    }
]
```

### 2. 按項分割模式 ✅

**實現位置**：`StructuredHierarchicalChunking._build_item_chunk()`

**功能特點**：

- 新增 `chunk_by: "item"` 選項
- 每個條文項目獨立成塊
- 保留完整的層次結構信息

**前端選項**：

```
按條文分割：每條法律條文獨立成塊（推薦）
按項分割：每個條文項目獨立成塊（精細化）
按節分割：每個章節獨立成塊
按章分割：每個章獨立成塊
```

### 3. 引用關係處理 ✅

**已實現功能**：

- 交叉引用提取：`extract_cross_references()`
- 引用類型識別：條文引用、自引用、外部引用
- metadata 存儲：`cross_references` 字段

**支持的引用模式**：

- 條文引用：`第X條第Y項`
- 自引用：`本法`、`本條例`
- 外部引用：`其他法律`、`相關法規`

## 評測系統改進

### 1. 策略感知評測 ✅

- 不同分割策略產生不同評測結果
- 評測使用對應的分割策略
- 推薦配置反映實際策略效果

### 2. context precision 和 recall@K ✅

- 使用 TF-IDF + 余弦相似度
- 支持多個 k 值評估
- 計算 precision@K 和 recall@K

## 測試建議

### 1. 條文完整性測試

```bash
# 測試按條文分割
strategy: "structured_hierarchical"
chunk_by: "article"

# 測試按項分割
strategy: "structured_hierarchical"
chunk_by: "item"
```

### 2. span-based chunking 測試

```python
# 測試span準確性
chunks_with_span = chunker.chunk_with_span(text)
for chunk in chunks_with_span:
    print(f"Chunk: {chunk['chunk_id']}")
    print(f"Span: {chunk['span']}")
    print(f"Content: {chunk['content'][:100]}...")
```

### 3. 引用關係保留測試

- 檢查被引用的條文是否在同一 chunk 或相關 chunk 中
- 驗證 cross_references metadata 的準確性

## 預期效果

### 1. 條文召回率提升

**目標**：層次分割相比固定分割，條文完整召回率提升 30%

**測試方法**：

- 固定分割：使用滑動窗口
- 層次分割：使用按條文分割
- 比較 recall@K 指標

### 2. 精確度提升

**目標**：span-based chunking 使 precision@K 提升 15%

**測試方法**：

- 標準分塊 vs span-based 分塊
- 比較 precision@K 指標
- 特別關注邊界準確性

### 3. 引用關係保持

**目標**：確保引用關係在分塊後仍然有效

**測試方法**：

- 檢查引用條文是否在同一 chunk
- 驗證跨 chunk 引用的處理

## 使用指南

### 1. 基本層次分割

```python
chunker = HierarchicalChunking()
chunks = chunker.chunk(text, max_chunk_size=1000, overlap_ratio=0.1)
```

### 2. 結構化層次分割

```python
chunker = StructuredHierarchicalChunking()
chunks = chunker.chunk(
    text,
    json_data=structured_data,
    chunk_by="article",  # 或 "item", "section", "chapter"
    max_chunk_size=1000
)
```

### 3. span-based 分割

```python
chunker = HierarchicalChunking()
chunks_with_span = chunker.chunk_with_span(text, max_chunk_size=1000)
```

## 總結

現在的層次分割實現已經達到了專業標準：

✅ **規則-based 分割**：完整的「章-節-條-項」結構識別
✅ **span-based chunking**：精確的邊界標記和 metadata
✅ **按項分割**：精細化的分割粒度選擇
✅ **引用關係處理**：交叉引用提取和 metadata 存儲
✅ **策略感知評測**：不同策略產生不同結果
✅ **LegalBench-RAG 兼容**：支持專業評測指標

建議測試重點：

1. 按條文分割 vs 按項分割的效果對比
2. 層次分割 vs 固定分割的召回率提升
3. span-based chunking 對精確度的影響
4. 引用關係在分塊後的保持情況

這些改進讓層次分割真正達到了法律文檔 RAG 的專業標準！
