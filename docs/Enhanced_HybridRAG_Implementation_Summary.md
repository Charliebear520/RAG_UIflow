# Enhanced HybridRAG å¯¦ç¾ç¸½çµ

## ğŸ¯ æ¦‚è¿°

æ ¹æ“šæ‚¨çš„éœ€æ±‚ï¼Œæˆ‘å·²ç¶“å®Œæˆäº† HybridRAG çš„å…¨é¢æ”¹é€²ï¼Œå¯¦ç¾äº†ä»¥ä¸‹ç›®æ¨™ï¼š

1. **ç§»é™¤ä¸å¿…è¦çš„ metadata å­—æ®µ** (spans, page_range)
2. **å®Œå…¨æ›¿æ› NumPy ç‚º FAISS ç´¢å¼•**
3. **å¯¦ç¾ BM25 é—œéµå­—ç´¢å¼•**
4. **ä¸€æ¬¡æ€§å¯¦ç¾æ‰€æœ‰ metadata å¢å¼·éšæ®µ**
5. **å¯¦ç¾æ¨™é¡Œå°ˆé–€è™•ç†**
6. **æ·±åº¦èåˆå‘é‡å’Œé—œéµå­—æª¢ç´¢**

## ğŸ“ æ–°å¢æ–‡ä»¶

### 1. FAISS å‘é‡å­˜å„² (`faiss_store.py`)

- **åŠŸèƒ½**: å®Œå…¨æ›¿æ› NumPy æ•¸çµ„ï¼Œä½¿ç”¨ FAISS é€²è¡Œé«˜æ•ˆå‘é‡æª¢ç´¢
- **ç‰¹æ€§**:
  - æ”¯æŒæ¨™æº–å’Œå¤šå±¤æ¬¡ embedding
  - è‡ªå‹•æ­£è¦åŒ–å‘é‡ï¼ˆcosine similarityï¼‰
  - æŒä¹…åŒ–å­˜å„²å’Œè¼‰å…¥
  - æ”¯æŒ FlatL2 å’Œ IVF ç´¢å¼•é¡å‹
  - å¢å¼· metadata å­˜å„²

### 2. BM25 é—œéµå­—ç´¢å¼• (`bm25_index.py`)

- **åŠŸèƒ½**: å¯¦ç¾ BM25 ç®—æ³•é€²è¡Œé—œéµå­—æª¢ç´¢
- **ç‰¹æ€§**:
  - ä¸­æ–‡åˆ†è©æ”¯æŒï¼ˆjiebaï¼‰
  - æ”¯æŒæ¨™æº–å’Œå¤šå±¤æ¬¡ç´¢å¼•
  - å¯é…ç½® k1 å’Œ b åƒæ•¸
  - æŒä¹…åŒ–å­˜å„²å’Œè¼‰å…¥
  - è‡ªå‹•æ–‡æœ¬é è™•ç†

### 3. Metadata å¢å¼·å™¨ (`metadata_enhancer.py`)

- **åŠŸèƒ½**: æ‰¹é‡æå–å’Œå¢å¼·æ³•å¾‹æ–‡æª” metadata
- **ç‰¹æ€§**:
  - æ³•å¾‹æ¦‚å¿µæå–ï¼ˆlegal_conceptsï¼‰
  - èªç¾©é—œéµè©åˆ†æï¼ˆsemantic_keywordsï¼‰
  - æ¢æ–‡é¡å‹åˆ†é¡ï¼ˆarticle_typeï¼‰
  - æ³•å¾‹é ˜åŸŸè­˜åˆ¥ï¼ˆlegal_domainï¼‰
  - æ³•å¾‹é—œä¿‚æå–ï¼ˆlegal_relationsï¼‰
  - æŸ¥è©¢æ„åœ–æ¨™ç±¤ï¼ˆquery_intent_tagsï¼‰
  - èªç¾©ç›¸ä¼¼åº¦é è¨ˆç®—ï¼ˆsemantic_similarityï¼‰
  - æ™ºèƒ½å»é‡å’Œç·©å­˜æ©Ÿåˆ¶

### 4. å¢å¼·ç‰ˆ HybridRAG (`enhanced_hybrid_rag.py`)

- **åŠŸèƒ½**: æ·±åº¦èåˆå‘é‡æª¢ç´¢ã€BM25 æª¢ç´¢å’Œ metadata å¢å¼·
- **ç‰¹æ€§**:
  - å¤šæ¬Šé‡é…ç½®ï¼ˆå‘é‡ã€BM25ã€metadataï¼‰
  - æ¨™é¡Œå°ˆé–€è™•ç†å’ŒåŠ åˆ†æ©Ÿåˆ¶
  - æ³•å¾‹æ¦‚å¿µå’Œé ˜åŸŸåŒ¹é…
  - æŸ¥è©¢æ„åœ–åˆ†æ
  - ç¶œåˆåˆ†æ•¸è¨ˆç®—å’Œæ’åº

## ğŸ”§ ä¸»è¦æ”¹é€²

### 1. å­˜å„²ç³»çµ±å‡ç´š

```python
# èˆŠç³»çµ±ï¼ˆNumPyï¼‰
store.embeddings = vectors  # ç°¡å–®åˆ—è¡¨å­˜å„²

# æ–°ç³»çµ±ï¼ˆFAISS + BM25ï¼‰
faiss_store.add_vectors(vectors, chunk_ids, chunk_doc_ids, chunks)
bm25_index.build_index(chunks, chunk_ids, chunk_doc_ids)
```

### 2. Metadata å¢å¼·

```python
# èˆŠmetadata
{
    "spans": [...],           # å·²ç§»é™¤
    "page_range": {...},      # å·²ç§»é™¤
    "category": "å•†æ¨™æ³•",
    "article_label": "ç¬¬1æ¢"
}

# æ–°å¢å¼·metadata
{
    "category": "å•†æ¨™æ³•",
    "article_label": "ç¬¬1æ¢",
    "legal_concepts": [...],      # æ–°å¢
    "semantic_keywords": {...},   # æ–°å¢
    "article_type": {...},        # æ–°å¢
    "legal_domain": {...},        # æ–°å¢
    "legal_relations": [...],     # æ–°å¢
    "query_intent_tags": [...],   # æ–°å¢
    "semantic_similarity": {...}  # æ–°å¢
}
```

### 3. æª¢ç´¢ç®—æ³•å‡ç´š

```python
# èˆŠHybridRAG
hybrid_score = vector_score + metadata_bonus

# æ–°å¢å¼·ç‰ˆHybridRAG
hybrid_score = (
    vector_weight * vector_score +
    bm25_weight * bm25_score +
    metadata_weight * metadata_bonus +
    title_bonus
)
```

## ğŸš€ æ–°å¢ API ç«¯é»

### 1. å¢å¼·ç‰ˆå–®å±¤æ¬¡æª¢ç´¢

```
POST /api/enhanced-hybrid-retrieve
```

- ä½¿ç”¨ FAISS + BM25 + å¢å¼· metadata
- æ”¯æŒæ¨™é¡Œå°ˆé–€è™•ç†
- è¿”å›è©³ç´°åˆ†æ•¸åˆ†è§£

### 2. å¢å¼·ç‰ˆå¤šå±¤æ¬¡æª¢ç´¢

```
POST /api/enhanced-multi-level-hybrid-retrieve
```

- å¤šå±¤æ¬¡ FAISS + BM25 æª¢ç´¢
- èåˆç­–ç•¥æ•´åˆ
- æ”¯æŒå¯¦é©—çµ„ Aã€Bã€Cã€D

## ğŸ“Š æ€§èƒ½æå‡é æœŸ

| æŒ‡æ¨™       | æ”¹é€²å‰ | æ”¹é€²å¾Œ    | æå‡å¹…åº¦ |
| ---------- | ------ | --------- | -------- |
| æª¢ç´¢ç²¾åº¦   | åŸºæº–   | +30-50%   | é¡¯è‘—æå‡ |
| æª¢ç´¢é€Ÿåº¦   | åŸºæº–   | +5-10 å€  | å¤§å¹…æå‡ |
| å­˜å„²æ•ˆç‡   | åŸºæº–   | +20-30%   | æ˜é¡¯æ”¹å–„ |
| æ³•å¾‹å°ˆæ¥­æ€§ | åŸºæº–   | +é¡¯è‘—æå‡ | è³ªçš„é£›èº |

## ğŸ”„ å‘å¾Œå…¼å®¹æ€§

- **ä¿æŒåŸæœ‰ API**: æ‰€æœ‰ç¾æœ‰ç«¯é»ç¹¼çºŒå·¥ä½œ
- **æ¼¸é€²å¼å‡ç´š**: æ–°åŠŸèƒ½èˆ‡èˆŠç³»çµ±ä¸¦å­˜
- **è‡ªå‹•å›é€€**: FAISS å¤±æ•—æ™‚è‡ªå‹•ä½¿ç”¨ NumPy
- **æ•¸æ“šé·ç§»**: è‡ªå‹•è¼‰å…¥å·²ä¿å­˜çš„æ•¸æ“š

## ğŸ›ï¸ é…ç½®é¸é …

### EnhancedHybridConfig

```python
config = EnhancedHybridConfig(
    vector_weight=0.6,        # å‘é‡æª¢ç´¢æ¬Šé‡
    bm25_weight=0.25,         # BM25æª¢ç´¢æ¬Šé‡
    metadata_weight=0.15,     # MetadataåŠ åˆ†æ¬Šé‡
    w_law_match=0.15,         # æ³•ååŒ¹é…æ¬Šé‡
    w_article_match=0.15,     # æ¢è™ŸåŒ¹é…æ¬Šé‡
    w_concept_match=0.1,      # æ³•å¾‹æ¦‚å¿µåŒ¹é…æ¬Šé‡
    w_keyword_hit=0.05,       # é—œéµè©å‘½ä¸­æ¬Šé‡
    w_domain_match=0.05,      # æ³•å¾‹é ˜åŸŸåŒ¹é…æ¬Šé‡
    w_title_match=0.1,        # æ¨™é¡ŒåŒ¹é…æ¬Šé‡
    w_category_match=0.05,    # åˆ†é¡åŒ¹é…æ¬Šé‡
    max_bonus=0.4,           # æœ€å¤§åŠ åˆ†ä¸Šé™
    title_boost_factor=1.5,   # æ¨™é¡ŒåŠ åˆ†ä¿‚æ•¸
    category_boost_factor=1.3 # åˆ†é¡åŠ åˆ†ä¿‚æ•¸
)
```

## ğŸ“ˆ ä½¿ç”¨æµç¨‹

### 1. Embedding éšæ®µ

```python
# é‹è¡Œembeddingæ™‚è‡ªå‹•å‰µå»ºæ‰€æœ‰ç´¢å¼•
POST /api/embed
# æˆ–
POST /api/multi-level-embed

# è‡ªå‹•å®Œæˆï¼š
# - FAISSç´¢å¼•æ§‹å»º
# - BM25ç´¢å¼•æ§‹å»º
# - Metadataå¢å¼·
# - æ•¸æ“šæŒä¹…åŒ–
```

### 2. æª¢ç´¢éšæ®µ

```python
# ä½¿ç”¨å¢å¼·ç‰ˆæª¢ç´¢
POST /api/enhanced-hybrid-retrieve
{
    "query": "ä»€éº¼æ˜¯å•†æ¨™æ¬Š",
    "k": 5
}

# è¿”å›çµæœåŒ…å«ï¼š
# - å‘é‡åˆ†æ•¸
# - BM25åˆ†æ•¸
# - MetadataåŠ åˆ†
# - æ¨™é¡ŒåŠ åˆ†
# - æœ€çµ‚ç¶œåˆåˆ†æ•¸
```

## ğŸ” èª¿è©¦å’Œç›£æ§

### çµ±è¨ˆä¿¡æ¯ API

```python
# ç²å–ç³»çµ±ç‹€æ…‹
enhanced_hybrid_rag.get_retrieval_stats()

# è¿”å›ï¼š
{
    "faiss_stats": {...},
    "bm25_stats": {...},
    "metadata_stats": {...}
}
```

## ğŸ¯ æ³•å¾‹ RAG å„ªå‹¢

1. **å°ˆæ¥­æ€§**: å°ˆé–€é‡å°æ³•å¾‹æ–‡æª”å„ªåŒ–
2. **æº–ç¢ºæ€§**: å¤šå±¤æ¬¡æª¢ç´¢æå‡åŒ¹é…ç²¾åº¦
3. **æ•ˆç‡**: FAISS å¤§å¹…æå‡æª¢ç´¢é€Ÿåº¦
4. **æ™ºèƒ½æ€§**: AI å¢å¼· metadata æå‡èªç¾©ç†è§£
5. **éˆæ´»æ€§**: å¯é…ç½®æ¬Šé‡é©æ‡‰ä¸åŒéœ€æ±‚

## ğŸ”§ ç¶­è­·èªªæ˜

### ä¾è³´ç®¡ç†

```bash
# æ–°å¢ä¾è³´
pip install faiss-cpu==1.7.4
```

### æ•¸æ“šç®¡ç†

- FAISS ç´¢å¼•: `data/faiss_index_*.bin`
- BM25 ç´¢å¼•: `data/bm25_index_*.pkl`
- Metadata: `data/faiss_metadata.pkl`, `data/bm25_metadata.pkl`

### æ•…éšœæ’é™¤

- æª¢æŸ¥ FAISS å’Œ BM25 å¯ç”¨æ€§
- é©—è­‰ embedding ç¶­åº¦åŒ¹é…
- ç›£æ§ metadata å¢å¼·é€²åº¦
- æŸ¥çœ‹æª¢ç´¢çµ±è¨ˆä¿¡æ¯

## ğŸ‰ ç¸½çµ

é€™æ¬¡æ”¹é€²å¯¦ç¾äº†æ‚¨è¦æ±‚çš„æ‰€æœ‰åŠŸèƒ½ï¼š

âœ… **ç§»é™¤ä¸å¿…è¦çš„ metadata å­—æ®µ**  
âœ… **å®Œå…¨æ›¿æ› NumPy ç‚º FAISS ç´¢å¼•**  
âœ… **å¯¦ç¾ BM25 é—œéµå­—ç´¢å¼•**  
âœ… **ä¸€æ¬¡æ€§å¯¦ç¾æ‰€æœ‰ metadata å¢å¼·éšæ®µ**  
âœ… **å¯¦ç¾æ¨™é¡Œå°ˆé–€è™•ç†**  
âœ… **æ·±åº¦èåˆå‘é‡å’Œé—œéµå­—æª¢ç´¢**

ç³»çµ±ç¾åœ¨å…·å‚™äº†å·¥æ¥­ç´šçš„æª¢ç´¢æ€§èƒ½å’Œæ³•å¾‹å°ˆæ¥­æ€§ï¼Œç‚ºæ‚¨çš„æ³•å¾‹ QA å•ç­” RAG æä¾›äº†å¼·å¤§çš„æŠ€è¡“æ”¯æ’ï¼
