# HopRAG 自动持久化功能说明

## 🎯 问题解决

**问题：** 每次服务器重启都需要重新构建 HopRAG 图谱，耗时 2-3 分钟

**解决：** 添加自动持久化功能，只需构建一次，之后自动加载

---

## ✅ 功能特点

### 1. **自动保存**

- ✅ 构建 HopRAG 图谱后自动保存到磁盘
- ✅ 保存为 `.pkl` 文件（快速、高效）
- ✅ 同时保存元数据（JSON 格式，方便查看）

### 2. **自动加载**

- ✅ 服务器启动时自动检测已保存的图谱
- ✅ 自动加载到内存，无需重新构建
- ✅ 加载速度：通常<1 秒

### 3. **智能管理**

- ✅ 检测图谱是否存在
- ✅ 显示保存时间和文件大小
- ✅ 支持手动保存/加载/删除

---

## 📁 存储位置

```
/Users/charliebear/Desktop/code/RAG/backend/
└── hoprag_storage/
    ├── hoprag_graph.pkl      # 图谱数据（pickle格式）
    └── metadata.json          # 元数据（JSON格式）
```

**文件说明：**

- `hoprag_graph.pkl`: 包含所有节点、边、伪查询、embedding 等
- `metadata.json`: 保存时间、统计信息、文件大小等

---

## 🚀 使用流程

### **首次使用（需要构建）**

1. **启动服务器**

```bash
cd /Users/charliebear/Desktop/code/RAG/backend
source venv/bin/activate
uvicorn app.main:app --reload
```

**控制台输出：**

```
============================================================
🔍 检查是否有已保存的HopRAG图谱...
============================================================
ℹ️ 未找到已保存的图谱，首次使用需要构建HopRAG图谱
============================================================
```

2. **前端构建 HopRAG 图谱**

- 选择 "HopRAG (多跳推理检索) 🧠"
- 点击 "构建 HopRAG 图谱"
- 等待 2-3 分钟

**控制台输出：**

```
✅ HopRAG圖譜構建成功！節點: 307, 邊: 1250

💾 自動保存HopRAG圖譜...
✅ HopRAG圖譜保存成功！
   文件大小: 15.32 MB
   保存时间: 1.2秒
   位置: hoprag_storage/hoprag_graph.pkl
```

3. **完成！图谱已保存**

---

### **后续使用（自动加载）**

1. **重启服务器**

```bash
uvicorn app.main:app --reload
```

**控制台输出：**

```
============================================================
🔍 检查是否有已保存的HopRAG图谱...
============================================================
📂 发现已保存的图谱，尝试自动加载...
   保存时间: 2025-10-07T14:30:25
   文件大小: 15.32 MB
✅ HopRAG圖譜加载成功！
   加载时间: 0.8秒
   统计信息: {'total_nodes': 307, 'total_edges': 1250, ...}
✅ HopRAG图谱自动加载成功！无需重新构建
============================================================
```

2. **直接使用 HopRAG 检索**

- 无需再次构建
- 直接输入查询并检索
- ⚡ 节省 2-3 分钟构建时间！

---

## 📊 性能对比

### **之前（无持久化）**

```
服务器启动 → 构建图谱(2-3分钟) → 可以检索
   ↓
重启服务器 → 构建图谱(2-3分钟) → 可以检索
   ↓
重启服务器 → 构建图谱(2-3分钟) → 可以检索
```

**每次重启都要等 2-3 分钟** ❌

### **现在（自动持久化）**

```
服务器启动(首次) → 构建图谱(2-3分钟) + 保存(1秒) → 可以检索
   ↓
重启服务器 → 自动加载(<1秒) → 可以检索 ✅
   ↓
重启服务器 → 自动加载(<1秒) → 可以检索 ✅
```

**后续重启只需<1 秒** ✅

---

## 🛠️ API 端点

### 1. **查看存储信息**

```http
GET /api/hoprag-storage-info
```

**响应示例：**

```json
{
  "storage_info": {
    "storage_dir": "hoprag_storage",
    "has_saved_graph": true,
    "file_size_mb": 15.32,
    "save_time": "2025-10-07T14:30:25",
    "statistics": {
      "total_nodes": 307,
      "total_edges": 1250
    }
  },
  "timestamp": "2025-10-07T15:00:00"
}
```

### 2. **手动保存图谱**

```http
POST /api/hoprag-save
```

**用途：** 在修改图谱后手动保存

### 3. **手动加载图谱**

```http
POST /api/hoprag-load
```

**用途：** 重新加载已保存的图谱

### 4. **重置系统**

```http
POST /api/hoprag-reset
```

**功能：** 重置系统并删除已保存的图谱

---

## 🔍 常见问题

### Q1: 图谱保存在哪里？

**A:** `backend/hoprag_storage/` 目录（自动创建）

### Q2: 文件有多大？

**A:** 通常 10-20MB（取决于法规数量），307 个节点约 15MB

### Q3: 如果我修改了法规文本怎么办？

**A:** 需要重新构建图谱，旧的会被自动覆盖

### Q4: 可以删除已保存的图谱吗？

**A:** 可以，使用 `POST /api/hoprag-reset` 或手动删除 `hoprag_storage/` 目录

### Q5: 自动加载失败怎么办？

**A:** 控制台会显示错误信息，需要重新构建图谱

### Q6: 支持多个法规文档吗？

**A:** 支持，所有文档的图谱会合并保存

### Q7: 我更新了代码，需要重新构建吗？

**A:**

- 更新了分块/embedding：**需要重新构建**
- 只更新了检索逻辑：**不需要重新构建**

---

## ⚠️ 注意事项

### 1. **何时需要重新构建？**

- ✅ 上传了新的法规文档
- ✅ 修改了分块策略
- ✅ 重新生成了 embedding
- ✅ 修改了 HopRAG 配置（如伪查询数量）

### 2. **何时可以直接使用？**

- ✅ 只是重启了服务器
- ✅ 修改了检索参数（如 k 值）
- ✅ 修改了前端代码

### 3. **备份建议**

如果图谱构建耗时很长，建议备份：

```bash
cp -r hoprag_storage/ hoprag_storage_backup/
```

### 4. **磁盘空间**

确保有足够空间（建议至少 100MB 可用）

---

## 📝 技术细节

### **保存内容**

- 所有节点（包括内容、元数据、embedding）
- 所有边（包括类型、权重）
- 所有伪查询（incoming/outgoing questions）
- 图谱统计信息
- 配置信息

### **保存格式**

- 使用 Python `pickle` 协议 5（最高协议）
- 支持复杂对象序列化
- 保留所有 numpy 数组和数据类型

### **加载过程**

1. 检测 `hoprag_graph.pkl` 文件
2. 读取并反序列化数据
3. 调用 `hoprag_system.import_graph_data()`
4. 重建 NetworkX 图结构
5. 恢复所有节点和边
6. 验证图谱完整性

---

## 🎉 总结

**优点：**

- ✅ 自动化：无需手动操作
- ✅ 快速：<1 秒加载 vs 2-3 分钟构建
- ✅ 可靠：pickle 格式保证数据完整
- ✅ 透明：控制台清晰显示所有操作

**效果：**

- 🚀 **启动速度提升 180x**（3 分钟 → 1 秒）
- 💰 **节省开发时间**（无需每次重启都等待）
- 📊 **改善用户体验**（快速开始检索）

**适用场景：**

- 开发调试时频繁重启服务器
- 生产环境需要快速恢复服务
- 法规内容稳定，无需频繁重新构建

---

**实现时间：** 2025-10-07  
**影响范围：** HopRAG 图谱构建和检索  
**优先级：** 🟢 优化（大幅提升效率）
