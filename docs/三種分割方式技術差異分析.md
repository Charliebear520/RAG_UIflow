# 三種分割方式技術差異分析

## 1. 層次分割 (Hierarchical Chunking)

### 技術原理

```
基於正則表達式識別法律文檔的層次結構
```

### 分割邏輯

```python
# 識別結構標記
chapter_patterns = [r'^第\s*([一二三四五六七八九十百千0-9]+)\s*章']
article_patterns = [r'^第\s*([一二三四五六七八九十百千0-9]+)\s*條']
item_patterns = [r'^[（(]([0-9]+)[）)]']

# 分割策略
- 在條文邊界強制分割
- 超過max_chunk_size時強制分割
- 簡單的重疊處理
```

### 特點

- ✅ **結構識別**: 能識別章、條、項
- ✅ **簡單可靠**: 邏輯清晰，穩定
- ❌ **分割粗糙**: 沒有智能分隔符處理
- ❌ **長文本處理**: 對超長條文處理不夠優雅

### 評測結果

- **chunk_size**: 300 (較小)
- **overlap_ratio**: 0.0 (無重疊)
- **chunk_count**: 96 (適中)
- **平均長度**: 266.4

---

## 2. RCTS 層次分割 (RCTS Hierarchical Chunking)

### 技術原理

```
結合RecursiveCharacterTextSplitter + 層次結構識別
```

### 分割邏輯

```python
# RCTS智能分隔符優先級
separators = [
    "\n\n",  # 段落分隔
    "\n",    # 行分隔
    "。",    # 句號
    "；",    # 分號
    "，",    # 逗號
    "、",    # 頓號
    " ",     # 空格
    ""       # 字符級別
]

# 分割策略
- 在條文邊界強制分割 (保持法律邏輯)
- 對於過大的chunk，使用RCTS進一步智能分割
- 保持結構信息前綴
- 智能重疊處理
```

### 特點

- ✅ **智能分隔符**: RCTS 的遞歸分割能力
- ✅ **結構保持**: 在條文邊界強制分割
- ✅ **長文本優化**: 優雅處理超長條文
- ✅ **中文優化**: 針對中文標點符號優化
- ✅ **上下文保持**: 結構信息前綴

### 評測結果

- **chunk_size**: 800 (較大)
- **overlap_ratio**: 0.2 (適當重疊)
- **chunk_count**: 136 (較多)
- **平均長度**: 290.5

---

## 3. 結構化層次分割 (Structured Hierarchical Chunking)

### 技術原理

```
基於JSON結構數據進行精確分割
```

### 分割邏輯

```python
# 基於JSON結構
{
  "chapters": [
    {
      "sections": [
        {
          "articles": [
            {
              "items": [...]
            }
          ]
        }
      ]
    }
  ]
}

# 分割策略
- 按JSON結構的章-節-條-項分割
- 可選擇分割粒度: chapter/section/article/item
- 精確的結構邊界識別
- 保持完整的層次信息
```

### 特點

- ✅ **精確結構**: 基於預解析的 JSON 結構
- ✅ **靈活粒度**: 可選擇分割級別
- ✅ **法律邏輯**: 完美保持法律文檔結構
- ✅ **引用關係**: 支持條文引用處理
- ❌ **依賴數據**: 需要高質量的 PDF 解析
- ❌ **可能過細**: 按項分割可能過於細分

### 評測結果

- **chunk_size**: 300 (較小)
- **overlap_ratio**: 0.1 (輕微重疊)
- **chunk_count**: 147 (最多)
- **平均長度**: 132.1 (最短)

---

## 技術對比表

| 特性           | 層次分割   | RCTS 層次分割 | 結構化層次分割 |
| -------------- | ---------- | ------------- | -------------- |
| **分割方式**   | 正則表達式 | RCTS + 正則   | JSON 結構      |
| **分隔符處理** | 無         | 智能遞歸      | 結構邊界       |
| **長文本處理** | 粗糙       | 優雅          | 精確           |
| **結構保持**   | 基本       | 強制+智能     | 完美           |
| **分割粒度**   | 固定       | 自適應        | 可選           |
| **中文優化**   | 無         | 有            | 有             |
| **依賴數據**   | 無         | 無            | JSON 結構      |
| **計算複雜度** | 低         | 中            | 低             |

---

## 實際分割示例

### 相同文本的三種分割結果

**原始文本**:

```
第一章 總則
第一條 為保護著作權，保障著作人權益，調和社會公共利益，促進國家文化發展，特制定本法。
第二條 本法所稱著作，指屬於文學、科學、藝術或其他學術範圍之創作。
第三條 本法所稱著作人，指創作著作之人。
```

#### 1. 層次分割結果

```
Chunk 1: 第一章 總則
第一條 為保護著作權，保障著作人權益，調和社會公共利益，促進國家文化發展，特制定本法。
第二條 本法所稱著作，指屬於文學、科學、藝術或其他學術範圍之創作。
第三條 本法所稱著作人，指創作著作之人。
```

#### 2. RCTS 層次分割結果

```
Chunk 1: 【第一章 總則】
第一條 為保護著作權，保障著作人權益，調和社會公共利益，促進國家文化發展，特制定本法。

Chunk 2: 【第一章 總則】
第二條 本法所稱著作，指屬於文學、科學、藝術或其他學術範圍之創作。

Chunk 3: 【第一章 總則】
第三條 本法所稱著作人，指創作著作之人。
```

#### 3. 結構化層次分割結果

```
Chunk 1: 【著作權法】第一章 總則 第一條
為保護著作權，保障著作人權益，調和社會公共利益，促進國家文化發展，特制定本法。

Chunk 2: 【著作權法】第一章 總則 第二條
本法所稱著作，指屬於文學、科學、藝術或其他學術範圍之創作。

Chunk 3: 【著作權法】第一章 總則 第三條
本法所稱著作人，指創作著作之人。
```

---

## 性能差異分析

### 為什麼 RCTS 層次分割精確度最高？

1. **智能分隔符識別**

   - 在句號、分號等自然邊界分割
   - 避免切斷語義單元

2. **結構信息保持**

   - 每個 chunk 都有結構前綴
   - 保持法律文檔的層次關係

3. **適當的 chunk 大小**
   - 800 字符提供足夠上下文
   - 0.2 重疊提高檢索穩定性

### 為什麼結構化層次分割召回率最高？

1. **精確的條文分割**

   - 每個條文獨立成塊
   - 確保不遺漏任何法律條文

2. **最多分塊數量**

   - 147 個 chunk 提供最細粒度
   - 提高檢索覆蓋率

3. **完整結構信息**
   - 包含完整的層次路徑
   - 支持精確的法律引用

### 為什麼層次分割平衡性最好？

1. **適中的分塊數量**

   - 96 個 chunk 在數量和質量間平衡
   - 避免過度細分或過度粗分

2. **無重疊設計**

   - 避免冗餘信息
   - 適合結構化文檔

3. **穩定的結構識別**
   - 基本的正則表達式匹配
   - 可靠且可預測

---

## 應用場景建議

### 1. 法律問答系統

- **推薦**: RCTS 層次分割
- **原因**: 最高精確度，智能分隔符提高答案質量

### 2. 法律條文檢索

- **推薦**: 結構化層次分割
- **原因**: 最高召回率，確保不遺漏相關條文

### 3. 通用法律文檔處理

- **推薦**: 層次分割
- **原因**: 平衡性好，穩定可靠

### 4. 實時法律諮詢

- **推薦**: RCTS 層次分割
- **原因**: 快速響應，高精確度

### 5. 法律文檔分析

- **推薦**: 結構化層次分割
- **原因**: 完整結構信息，支持深度分析

---

## 總結

這三種分割方式代表了不同的技術路線：

1. **層次分割**: 傳統方法，簡單可靠
2. **RCTS 層次分割**: 現代方法，智能優化
3. **結構化層次分割**: 精確方法，完美結構

每種方法都有其適用場景，RCTS 層次分割在精確度和實用性間取得了最佳平衡，是最適合法律文檔 RAG 的選擇。
