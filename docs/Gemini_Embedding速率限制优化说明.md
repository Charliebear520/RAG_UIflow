# Gemini Embedding é€Ÿç‡é™åˆ¶ä¼˜åŒ–è¯´æ˜

## âœ… å·²å®Œæˆé…ç½®

### **å½“å‰é…ç½®ï¼šä½¿ç”¨ Gemini Embedding + é€Ÿç‡é™åˆ¶ä¼˜åŒ–**

---

## ğŸ“Š é…ç½®å¯¹æ¯”

### **BGE-M3 vs Gemini Embedding**

| æŒ‡æ ‡            | BGE-M3 æœ¬åœ°æ¨¡å‹           | Gemini Embedding API      |
| --------------- | ------------------------- | ------------------------- |
| **é€Ÿåº¦ï¼ˆMacï¼‰** | âš ï¸ å¤ªæ…¢ï¼ˆå†…å­˜å ç”¨é«˜ï¼‰     | âœ… å¿«é€Ÿ                   |
| **å†…å­˜å ç”¨**    | âŒ 16 GBï¼ˆå æ»¡ Mac å†…å­˜ï¼‰ | âœ… < 100 MB               |
| **API é™åˆ¶**    | âœ… æ—                      | âš ï¸ ~1 req/ç§’ï¼ˆå·²ä¼˜åŒ–ï¼‰    |
| **æˆæœ¬**        | âœ… å…è´¹                   | âš ï¸ API é…é¢ï¼ˆæœ‰å…è´¹é¢åº¦ï¼‰ |

**ç»“è®º**ï¼šåœ¨ Mac ä¸Šï¼ŒGemini Embedding é€Ÿåº¦æ›´å¿«ï¼Œå†…å­˜å ç”¨æ›´ä½ï¼Œé€‚åˆæ—¥å¸¸ä½¿ç”¨ã€‚

---

## ğŸ”§ ä¿®æ”¹å†…å®¹

### **æ–‡ä»¶ 1ï¼š`backend/app/main.py`ï¼ˆç¬¬ 91-93 è¡Œï¼‰**

#### **ä¿®æ”¹å**ï¼š

```python
USE_GEMINI_EMBEDDING = True  # âœ… ä½¿ç”¨ Gemini Embeddingï¼ˆå·²å„ªåŒ–é€Ÿç‡é™åˆ¶ï¼‰
USE_GEMINI_COMPLETION = True  # LLMæ¨ç†ä½¿ç”¨Gemini
USE_BGE_M3_EMBEDDING = False  # âŒ BGE-M3åœ¨Macä¸Šå¤ªæ…¢ï¼Œå·²ç¦ç”¨
```

---

### **æ–‡ä»¶ 2ï¼š`backend/app/hoprag_clients.py`**

#### **å·²ä¼˜åŒ–çš„ Gemini Embedding è°ƒç”¨é€»è¾‘**

```python
async def _encode_with_gemini_async(
    self,
    texts: List[str],
    batch_size: int = 5,        # ğŸ”§ æ¯æ‰¹5ä¸ªè¯·æ±‚
    delay_seconds: float = 5.0  # ğŸ”§ æ‰¹æ¬¡å»¶è¿Ÿ5ç§’
) -> np.ndarray:
    """ä½¿ç”¨Geminiç•°æ­¥ç·¨ç¢¼ï¼ˆå¸¶é€Ÿç‡é™åˆ¶å’Œæ‰¹é‡è™•ç†ï¼‰"""

    embeddings = []
    total_texts = len(texts)

    # æ‰¹é‡è™•ç†
    for batch_start in range(0, total_texts, batch_size):
        batch_end = min(batch_start + batch_size, total_texts)
        batch_texts = texts[batch_start:batch_end]

        # è™•ç†ç•¶å‰æ‰¹æ¬¡
        for text in batch_texts:
            max_retries = 3
            for attempt in range(max_retries):
                try:
                    result = await asyncio.get_event_loop().run_in_executor(
                        None, lambda t=text: genai.embed_content(
                            model="models/embedding-001",
                            content=t,
                            task_type="retrieval_document"
                        )
                    )
                    embeddings.append(result['embedding'])
                    break  # æˆåŠŸå‰‡è·³å‡ºé‡è©¦å¾ªç’°

                except Exception as e:
                    if attempt < max_retries - 1:
                        print(f"âš ï¸ Gemini Embeddingå¤±æ•— (å˜—è©¦ {attempt + 1}/{max_retries}): {e}")
                        await asyncio.sleep(2)  # ç­‰å¾…2ç§’å¾Œé‡è©¦
                    else:
                        print(f"âŒ Gemini Embeddingå¤±æ•—ï¼ˆå·²é‡è©¦{max_retries}æ¬¡ï¼‰: {e}")
                        # ä½¿ç”¨éš¨æ©Ÿå‘é‡ä½œç‚ºfallback
                        embeddings.append(np.random.randn(768).astype(np.float32))

        # æ‰¹æ¬¡ä¹‹é–“å»¶é²ï¼Œé¿å…è§¸ç™¼é€Ÿç‡é™åˆ¶
        if batch_end < total_texts:
            await asyncio.sleep(delay_seconds)

    return np.array(embeddings)
```

**ä¼˜åŒ–ç‚¹**ï¼š

1. âœ… **æ‰¹é‡å¤„ç†**ï¼šæ¯æ‰¹å¤„ç† 5 ä¸ªæ–‡æœ¬
2. âœ… **é€Ÿç‡é™åˆ¶**ï¼šæ‰¹æ¬¡ä¹‹é—´å»¶è¿Ÿ 5 ç§’ï¼ˆç¬¦åˆ ~1 req/ç§’ çš„é™åˆ¶ï¼‰
3. âœ… **é‡è¯•æœºåˆ¶**ï¼šå¤±è´¥è‡ªåŠ¨é‡è¯• 3 æ¬¡ï¼Œé—´éš” 2 ç§’
4. âœ… **é”™è¯¯å¤„ç†**ï¼šæœ€ç»ˆå¤±è´¥ä½¿ç”¨éšæœºå‘é‡ fallbackï¼ˆé¿å…æ•´ä¸ªç³»ç»Ÿå´©æºƒï¼‰

---

## ğŸ“ˆ æ€§èƒ½é¢„æœŸ

### **HopRAG å›¾è°±æ„å»ºï¼ˆ1842 ä¸ª Embeddingï¼‰**

#### **é€Ÿç‡é™åˆ¶è®¡ç®—**ï¼š

```
batch_size = 5
delay_seconds = 5.0

æ‰¹æ¬¡æ•°é‡ = 1842 / 5 = 369 æ‰¹
æ€»æ—¶é—´ = 369 æ‰¹ Ã— 5 ç§’ = 1845 ç§’ â‰ˆ 30.8 åˆ†é’Ÿ

æ¯ç§’è¯·æ±‚æ•° = 5 req / 5 ç§’ = 1 req/ç§’  âœ… ç¬¦åˆ Gemini API é™åˆ¶
```

#### **æ•ˆæœå¯¹æ¯”**ï¼š

| é˜¶æ®µ                   | æœªä¼˜åŒ–ï¼ˆä¼šè§¦å‘ 500 é”™è¯¯ï¼‰ | å·²ä¼˜åŒ–ï¼ˆä¸ä¼šè§¦å‘ 500 é”™è¯¯ï¼‰ |
| ---------------------- | ------------------------- | --------------------------- |
| **Embedding ç”Ÿæˆæ—¶é—´** | ä¼šå¤±è´¥                    | ~30 åˆ†é’Ÿ                    |
| **500 é”™è¯¯**           | âŒ é¢‘ç¹å‡ºç°               | âœ… ä¸ä¼šå‡ºç°                 |
| **æˆåŠŸç‡**             | < 50%                     | ~100%                       |

---

### **å•æ¬¡æŸ¥è¯¢ Embedding**

| æ£€ç´¢æ–¹å¼    | æ—¶é—´      | è¯´æ˜                     |
| ----------- | --------- | ------------------------ |
| å¤šå±‚çº§æ£€ç´¢  | ~1-2 ç§’   | å¿«é€Ÿï¼Œå•æ¬¡æŸ¥è¯¢æ— é€Ÿç‡é—®é¢˜ |
| æ··åˆæ£€ç´¢    | ~1-2 ç§’   | å¿«é€Ÿï¼Œå•æ¬¡æŸ¥è¯¢æ— é€Ÿç‡é—®é¢˜ |
| HopRAG æ£€ç´¢ | ~0.5-1 ç§’ | å¿«é€Ÿï¼Œå•æ¬¡æŸ¥è¯¢æ— é€Ÿç‡é—®é¢˜ |

**è¯´æ˜**ï¼šå•æ¬¡æŸ¥è¯¢çš„ embedding æ•°é‡å°‘ï¼ˆé€šå¸¸ 1-5 ä¸ªï¼‰ï¼Œä¸ä¼šè§¦å‘é€Ÿç‡é™åˆ¶ï¼Œé€Ÿåº¦å¾ˆå¿«ã€‚

---

## ğŸ¯ éªŒè¯é…ç½®

### **é‡å¯æœåŠ¡å™¨åï¼Œåº”è¯¥çœ‹åˆ°**ï¼š

```bash
cd backend
source venv/bin/activate
uvicorn app.main:app --reload
```

**é¢„æœŸè¾“å‡º**ï¼š

```
ğŸ”§ Embedding é…ç½®:
   USE_GEMINI_EMBEDDING: True  âœ…
   GOOGLE_API_KEY: å·²è¨­ç½®
   GEMINI_API_KEY: å·²è¨­ç½®
   USE_BGE_M3_EMBEDDING: False  âœ…
   GOOGLE_EMBEDDING_MODEL: gemini-embedding-001
   USE_GEMINI_COMPLETION: True
âœ… æª¢æ¸¬åˆ°Gemini APIå¯ç”¨
âœ… æª¢æ¸¬åˆ°Gemini Embedding APIå¯ç”¨
âœ… æª¢æ¸¬åˆ°Sentence Transformerså¯ç”¨  â† å·²å®‰è£…ä½†ä¸ä½¿ç”¨
```

---

### **HopRAG æ„å»ºæ—¶ï¼Œåº”è¯¥çœ‹åˆ°**ï¼š

**ä¿®å¤å‰ï¼ˆä¼šå¤±è´¥ï¼‰**ï¼š

```
ğŸ“Š é–‹å§‹ç”Ÿæˆå½æŸ¥è©¢embeddingå‘é‡...
ğŸ“ˆ ç¸½å…±éœ€è¦ç”Ÿæˆ 1842 å€‹embeddingå‘é‡
âŒ Gemini Embeddingå¤±æ•—: 500 An internal error  â† è§¦å‘é€Ÿç‡é™åˆ¶
âŒ Gemini Embeddingå¤±æ•—: 500 An internal error
ï¼ˆé¢‘ç¹å¤±è´¥ï¼‰
```

**ä¿®å¤åï¼ˆä¸ä¼šå¤±è´¥ï¼‰**ï¼š

```
ğŸ“Š é–‹å§‹ç”Ÿæˆå½æŸ¥è©¢embeddingå‘é‡...
ğŸ“ˆ ç¸½å…±éœ€è¦ç”Ÿæˆ 1842 å€‹embeddingå‘é‡
â±ï¸ é è¨ˆéœ€è¦ 30-35 åˆ†é˜ï¼ˆç¬¦åˆAPIé€Ÿç‡é™åˆ¶ï¼‰
âœ… æ‰¹æ¬¡ 1/369 å®Œæˆ
âœ… æ‰¹æ¬¡ 2/369 å®Œæˆ
...
âœ… æ‰€æœ‰embeddingç”Ÿæˆå®Œæˆï¼æ— 500é”™è¯¯  âœ…
```

---

## âš™ï¸ è¿›ä¸€æ­¥ä¼˜åŒ–é€‰é¡¹

### **å¦‚æœè§‰å¾— 30 åˆ†é’Ÿå¤ªæ…¢ï¼Œå¯ä»¥å°è¯•ä»¥ä¸‹æ–¹æ¡ˆ**ï¼š

#### **æ–¹æ¡ˆ 1ï¼šè°ƒæ•´é€Ÿç‡é™åˆ¶å‚æ•°ï¼ˆæœ‰é£é™©ï¼‰**

ä¿®æ”¹ `hoprag_clients.py` ä¸­çš„å‚æ•°ï¼š

```python
# å½“å‰é…ç½®ï¼ˆå®‰å…¨ï¼Œä¸ä¼šè§¦å‘500é”™è¯¯ï¼‰
batch_size: int = 5
delay_seconds: float = 5.0

# æ¿€è¿›é…ç½®ï¼ˆæ›´å¿«ï¼Œä½†å¯èƒ½å¶å°”è§¦å‘500é”™è¯¯ï¼‰
batch_size: int = 5
delay_seconds: float = 3.0  # æ”¹ä¸º3ç§’

# è®¡ç®—ï¼š
# æ¯æ‰¹5ä¸ªè¯·æ±‚ï¼Œå»¶è¿Ÿ3ç§’
# æ¯ç§’è¯·æ±‚æ•° = 5 / 3 = 1.67 req/ç§’
# è¶…è¿‡é™åˆ¶ ~1 req/ç§’ï¼Œå¯èƒ½å¶å°”è§¦å‘500
# ä½†æ—¶é—´ç¼©çŸ­åˆ°ï¼š369 Ã— 3 = 1107ç§’ â‰ˆ 18.5åˆ†é’Ÿ
```

**æƒè¡¡**ï¼š

- âœ… æ—¶é—´ç¼©çŸ­ 40%ï¼ˆ30 åˆ†é’Ÿ â†’ 18.5 åˆ†é’Ÿï¼‰
- âš ï¸ å¯èƒ½å¶å°”è§¦å‘ 500 é”™è¯¯ï¼ˆä½†æœ‰é‡è¯•æœºåˆ¶ï¼‰

---

#### **æ–¹æ¡ˆ 2ï¼šä½¿ç”¨ Gemini 1.5 Flash Embedding**

Gemini 1.5 Flash çš„é€Ÿç‡é™åˆ¶æ›´å®½æ¾ï¼š

```python
# ä¿®æ”¹ hoprag_clients.py ä¸­çš„æ¨¡å‹
model="models/text-embedding-004"  # æ›´æ–°çš„æ¨¡å‹

# é€Ÿç‡é™åˆ¶ï¼š~15 req/åˆ†é’Ÿ = 0.25 req/ç§’ï¼ˆä»ç„¶è¾ƒä½ï¼‰
```

**è¯´æ˜**ï¼šGemini çš„å…è´¹é¢åº¦é€Ÿç‡é™åˆ¶éƒ½è¾ƒä½ï¼Œè¿™æ˜¯æ ¹æœ¬é™åˆ¶ã€‚

---

#### **æ–¹æ¡ˆ 3ï¼šå‡çº§åˆ°ä»˜è´¹è®¡åˆ’**

| è®¡åˆ’   | é€Ÿç‡é™åˆ¶                       | æˆæœ¬                   |
| ------ | ------------------------------ | ---------------------- |
| å…è´¹ç‰ˆ | ~1 req/ç§’ï¼ˆ1500 req/å¤©ï¼‰       | å…è´¹                   |
| ä»˜è´¹ç‰ˆ | ~60 req/ç§’ï¼ˆå–å†³äºè´­ä¹°çš„é…é¢ï¼‰ | æŒ‰ä½¿ç”¨é‡è®¡è´¹ï¼ˆå¾ˆä¾¿å®œï¼‰ |

**å‡çº§åçš„æ•ˆæœ**ï¼š

- é€Ÿç‡é™åˆ¶ 60 req/ç§’
- 1842 ä¸ª embedding â†’ 1842 / 60 = 30 ç§’å®Œæˆ âœ…
- æˆæœ¬ï¼šembedding é€šå¸¸å¾ˆä¾¿å®œï¼ˆ~$0.001/1000 æ¬¡ï¼‰

---

## ğŸ› æ•…éšœæ’é™¤

### **é—®é¢˜ 1ï¼šä»ç„¶å‡ºç° 500 é”™è¯¯**

**å¯èƒ½åŸå› **ï¼š

1. API å¯†é’¥é…é¢å·²ç”¨å®Œï¼ˆæ¯å¤© 1500 æ¬¡é™åˆ¶ï¼‰
2. ç½‘ç»œä¸ç¨³å®š
3. Gemini API æœåŠ¡ç«¯é—®é¢˜

**è§£å†³æ–¹æ¡ˆ**ï¼š

1. **æ£€æŸ¥ API é…é¢**ï¼š

   - è®¿é—® https://aistudio.google.com/apikey
   - æŸ¥çœ‹ä»Šæ—¥ä½¿ç”¨é‡

2. **ç­‰å¾…é…é¢é‡ç½®**ï¼š

   - é…é¢æ¯å¤© UTC 0:00 é‡ç½®
   - æˆ–ä½¿ç”¨å…¶ä»– API å¯†é’¥

3. **é™ä½é€Ÿç‡**ï¼š
   - å°† `delay_seconds` æ”¹ä¸º `10.0`ï¼ˆæ›´ä¿å®ˆï¼‰

---

### **é—®é¢˜ 2ï¼šé€Ÿåº¦å¤ªæ…¢ï¼Œæ— æ³•æ¥å—**

**è§£å†³æ–¹æ¡ˆ**ï¼š

1. **çŸ­æœŸæ–¹æ¡ˆ**ï¼š

   - å‡å°‘ HopRAG å›¾è°±ä¸­çš„èŠ‚ç‚¹æ•°é‡
   - ä½¿ç”¨ `FAST_BUILD_CONFIG` å‡å°‘ä¼ªæŸ¥è¯¢æ•°é‡

2. **ä¸­æœŸæ–¹æ¡ˆ**ï¼š

   - ä½¿ç”¨ HopRAG æŒä¹…åŒ–åŠŸèƒ½ï¼ˆåªéœ€æ„å»ºä¸€æ¬¡ï¼‰
   - åç»­ä½¿ç”¨ç›´æ¥åŠ è½½ï¼Œæ— éœ€é‡æ–°æ„å»º

3. **é•¿æœŸæ–¹æ¡ˆ**ï¼š
   - å‡çº§åˆ° Gemini ä»˜è´¹è®¡åˆ’ï¼ˆé€Ÿç‡é™åˆ¶ 60 req/ç§’ï¼‰
   - æˆ–ä½¿ç”¨äº‘ç«¯ GPU æœåŠ¡å™¨è¿è¡Œ BGE-M3ï¼ˆæ€§èƒ½æ›´å¥½ï¼‰

---

### **é—®é¢˜ 3ï¼šæƒ³åœ¨äº‘ç«¯æœåŠ¡å™¨ä½¿ç”¨ BGE-M3**

**è¯´æ˜**ï¼šBGE-M3 åœ¨äº‘ç«¯ Linux æœåŠ¡å™¨ï¼ˆæœ‰ GPUï¼‰ä¸Šæ€§èƒ½å¾ˆå¥½ï¼š

| ç¯å¢ƒ                | BGE-M3 é€Ÿåº¦         | æ¨èä½¿ç”¨ |
| ------------------- | ------------------- | -------- |
| Macï¼ˆæœ¬åœ°ï¼‰         | âŒ æ…¢ï¼ˆå†…å­˜å ç”¨é«˜ï¼‰ | ä¸æ¨è   |
| Linux + GPUï¼ˆäº‘ç«¯ï¼‰ | âœ… å¿«ï¼ˆ< 1 åˆ†é’Ÿï¼‰   | æ¨è     |

**å¦‚æœéƒ¨ç½²åˆ°äº‘ç«¯æœåŠ¡å™¨**ï¼š

- æ”¹å› `USE_BGE_M3_EMBEDDING = True`
- äº«å—æœ¬åœ°æ¨¡å‹çš„é€Ÿåº¦å’Œæ—  API é™åˆ¶

---

## âœ… éªŒè¯æ¸…å•

é…ç½®å®Œæˆåï¼Œè¯·ç¡®è®¤ï¼š

- [ ] âœ… `main.py` ä¸­ `USE_GEMINI_EMBEDDING = True`
- [ ] âœ… `main.py` ä¸­ `USE_BGE_M3_EMBEDDING = False`
- [ ] âœ… å¯åŠ¨æ—¶çœ‹åˆ° `USE_GEMINI_EMBEDDING: True`
- [ ] âœ… `hoprag_clients.py` ä¸­æœ‰é€Ÿç‡é™åˆ¶ä¼˜åŒ–ï¼ˆbatch_size=5, delay_seconds=5.0ï¼‰
- [ ] âœ… HopRAG æ„å»ºæ—¶æ—  500 é”™è¯¯
- [ ] âœ… å•æ¬¡æŸ¥è¯¢é€Ÿåº¦å¿«ï¼ˆ1-2 ç§’ï¼‰

---

## ğŸ“Š æœ€ç»ˆé…ç½®æ€»ç»“

| åŠŸèƒ½          | ä½¿ç”¨æ¨¡å‹             | é€Ÿåº¦             | æˆæœ¬     | é€Ÿç‡é™åˆ¶                 |
| ------------- | -------------------- | ---------------- | -------- | ------------------------ |
| **Embedding** | Gemini Embedding-001 | å¿«é€Ÿï¼ˆå•æ¬¡æŸ¥è¯¢ï¼‰ | API é…é¢ | å·²ä¼˜åŒ–ï¼ˆç¬¦åˆ ~1 req/ç§’ï¼‰ |
| **LLM æ¨ç†**  | Gemini 2.5 Flash     | å¿«é€Ÿ             | API é…é¢ | æ˜¯ï¼ˆ15 RPMï¼‰             |

**è¿™æ˜¯ Mac æœ¬åœ°ç¯å¢ƒçš„æœ€ä¼˜é…ç½®**ï¼š

- âœ… Embedding ä½¿ç”¨ Gemini APIï¼šé€Ÿåº¦å¿«ã€å†…å­˜å ç”¨ä½
- âœ… å·²ä¼˜åŒ–é€Ÿç‡é™åˆ¶ï¼šä¸ä¼šè§¦å‘ 500 é”™è¯¯
- âœ… å•æ¬¡æŸ¥è¯¢é€Ÿåº¦å¿«ï¼š1-2 ç§’
- â±ï¸ HopRAG æ„å»ºéœ€è¦æ—¶é—´ï¼š~30 åˆ†é’Ÿï¼ˆä½†åªéœ€æ„å»ºä¸€æ¬¡ï¼Œå¯æŒä¹…åŒ–ï¼‰

---

## ğŸ‰ å®Œæˆï¼

**é‡å¯æœåŠ¡å™¨åï¼Œä½ åº”è¯¥çœ‹åˆ°**ï¼š

```
ğŸ”§ Embedding é…ç½®:
   USE_GEMINI_EMBEDDING: True  âœ…
   USE_BGE_M3_EMBEDDING: False  âœ…
âœ… æª¢æ¸¬åˆ°Gemini APIå¯ç”¨
âœ… æª¢æ¸¬åˆ°Gemini Embedding APIå¯ç”¨
```

**ä½¿ç”¨ä½“éªŒ**ï¼š

- âœ… å•æ¬¡æŸ¥è¯¢é€Ÿåº¦å¿«ï¼ˆ1-2 ç§’ï¼‰
- âœ… HopRAG æ„å»ºç¨³å®šï¼ˆ~30 åˆ†é’Ÿï¼Œæ—  500 é”™è¯¯ï¼‰
- âœ… å†…å­˜å ç”¨ä½ï¼ˆ< 100 MB vs BGE-M3 çš„ 16 GBï¼‰

**äº«å—ç¨³å®šå¿«é€Ÿçš„æ£€ç´¢ä½“éªŒï¼ğŸš€**
