# 前端錯誤顯示修復說明

## 問題描述

用戶反映雖然錯誤處理邏輯已經修復，但是前端頁面上仍然顯示不友好的錯誤信息：

**前端顯示：**

```
啟動評測失敗: Error: 400 Bad Request
```

**控制台顯示：**

```
Error response data: Object
Error parsing response: Error: 請先使用「生成問題」功能為文檔生成測試問題，然後再進行評測
```

## 問題分析

錯誤信息確實被正確解析了，但是前端的錯誤處理邏輯有問題：

1. **錯誤被正確拋出**：`throw new Error(errorData.error)` 拋出了包含具體錯誤信息的 Error
2. **錯誤被 catch 塊捕獲**：拋出的 Error 被外層的 catch 塊捕獲
3. **條件判斷失敗**：`e.message.includes("error")` 沒有匹配到中文錯誤信息
4. **錯誤被重新拋出**：最終拋出的是 `400 Bad Request` 而不是具體的錯誤信息

## 修復內容

### 原來的錯誤邏輯

```typescript
try {
  const errorData = await res.json();
  throw new Error(errorData.error || `${res.status} ${res.statusText}`);
} catch (e) {
  if (e instanceof Error && e.message.includes("error")) {
    // 問題在這裡
    throw e;
  }
  throw new Error(`${res.status} ${res.statusText}`);
}
```

### 修復後的邏輯

```typescript
try {
  const errorData = await res.json();
  // 如果有具體的錯誤信息，直接拋出
  if (errorData.error) {
    throw new Error(errorData.error);
  }
  throw new Error(`${res.status} ${res.statusText}`);
} catch (e) {
  // 如果已經是一個Error對象且有具體信息，直接重新拋出
  if (
    e instanceof Error &&
    e.message !== "Unexpected token < in JSON at position 0"
  ) {
    throw e;
  }
  // 如果解析失敗或其他錯誤，拋出通用錯誤
  throw new Error(`${res.status} ${res.statusText}`);
}
```

### 修復要點

1. **直接拋出具體錯誤**：當有`errorData.error`時，直接拋出包含具體信息的 Error
2. **避免重複處理**：在 catch 塊中檢查是否已經是有具體信息的 Error，如果是就直接重新拋出
3. **排除解析錯誤**：排除 JSON 解析錯誤，避免誤判
4. **保留調試信息**：保留 console.log 用於調試

## 修復效果

### 修復前

```
啟動評測失敗: Error: 400 Bad Request
```

### 修復後

```
啟動評測失敗: Error: 請先使用「生成問題」功能為文檔生成測試問題，然後再進行評測
```

## 測試步驟

1. 刷新瀏覽器頁面（確保加載最新代碼）
2. 嘗試沒有生成問題就直接點擊評測
3. 檢查前端頁面是否顯示友好的錯誤提示
4. 如果仍顯示舊錯誤，清除瀏覽器緩存或使用硬刷新

## 總結

這次修復解決了前端錯誤顯示的問題：

✅ **錯誤信息正確傳遞**：具體的錯誤信息從後端正確傳遞到前端
✅ **用戶體驗改善**：用戶能看到明確的操作指導
✅ **調試信息保留**：控制台仍有詳細的調試信息
✅ **邏輯完整性**：錯誤處理邏輯更加健壯

現在用戶能夠清楚地知道需要先生成問題才能進行評測，提供了更好的用戶體驗。
